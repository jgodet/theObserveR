% Options for packages loaded elsewhere
\PassOptionsToPackage{unicode}{hyperref}
\PassOptionsToPackage{hyphens}{url}
\PassOptionsToPackage{dvipsnames,svgnames*,x11names*}{xcolor}
%
\documentclass[
]{article}
\usepackage{amsmath,amssymb}
\usepackage{lmodern}
\usepackage{ifxetex,ifluatex}
\ifnum 0\ifxetex 1\fi\ifluatex 1\fi=0 % if pdftex
  \usepackage[T1]{fontenc}
  \usepackage[utf8]{inputenc}
  \usepackage{textcomp} % provide euro and other symbols
\else % if luatex or xetex
  \usepackage{unicode-math}
  \defaultfontfeatures{Scale=MatchLowercase}
  \defaultfontfeatures[\rmfamily]{Ligatures=TeX,Scale=1}
\fi
% Use upquote if available, for straight quotes in verbatim environments
\IfFileExists{upquote.sty}{\usepackage{upquote}}{}
\IfFileExists{microtype.sty}{% use microtype if available
  \usepackage[]{microtype}
  \UseMicrotypeSet[protrusion]{basicmath} % disable protrusion for tt fonts
}{}
\makeatletter
\@ifundefined{KOMAClassName}{% if non-KOMA class
  \IfFileExists{parskip.sty}{%
    \usepackage{parskip}
  }{% else
    \setlength{\parindent}{0pt}
    \setlength{\parskip}{6pt plus 2pt minus 1pt}}
}{% if KOMA class
  \KOMAoptions{parskip=half}}
\makeatother
\usepackage{xcolor}
\IfFileExists{xurl.sty}{\usepackage{xurl}}{} % add URL line breaks if available
\IfFileExists{bookmark.sty}{\usepackage{bookmark}}{\usepackage{hyperref}}
\hypersetup{
  colorlinks=true,
  linkcolor=Maroon,
  filecolor=Maroon,
  citecolor=Blue,
  urlcolor=blue,
  pdfcreator={LaTeX via pandoc}}
\urlstyle{same} % disable monospaced font for URLs
\usepackage[margin=1in]{geometry}
\usepackage{color}
\usepackage{fancyvrb}
\newcommand{\VerbBar}{|}
\newcommand{\VERB}{\Verb[commandchars=\\\{\}]}
\DefineVerbatimEnvironment{Highlighting}{Verbatim}{commandchars=\\\{\}}
% Add ',fontsize=\small' for more characters per line
\usepackage{framed}
\definecolor{shadecolor}{RGB}{248,248,248}
\newenvironment{Shaded}{\begin{snugshade}}{\end{snugshade}}
\newcommand{\AlertTok}[1]{\textcolor[rgb]{0.94,0.16,0.16}{#1}}
\newcommand{\AnnotationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\AttributeTok}[1]{\textcolor[rgb]{0.77,0.63,0.00}{#1}}
\newcommand{\BaseNTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\BuiltInTok}[1]{#1}
\newcommand{\CharTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\CommentTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\CommentVarTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ConstantTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ControlFlowTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\DataTypeTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{#1}}
\newcommand{\DecValTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\DocumentationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\ErrorTok}[1]{\textcolor[rgb]{0.64,0.00,0.00}{\textbf{#1}}}
\newcommand{\ExtensionTok}[1]{#1}
\newcommand{\FloatTok}[1]{\textcolor[rgb]{0.00,0.00,0.81}{#1}}
\newcommand{\FunctionTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\ImportTok}[1]{#1}
\newcommand{\InformationTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\newcommand{\KeywordTok}[1]{\textcolor[rgb]{0.13,0.29,0.53}{\textbf{#1}}}
\newcommand{\NormalTok}[1]{#1}
\newcommand{\OperatorTok}[1]{\textcolor[rgb]{0.81,0.36,0.00}{\textbf{#1}}}
\newcommand{\OtherTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{#1}}
\newcommand{\PreprocessorTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textit{#1}}}
\newcommand{\RegionMarkerTok}[1]{#1}
\newcommand{\SpecialCharTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\SpecialStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\StringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\VariableTok}[1]{\textcolor[rgb]{0.00,0.00,0.00}{#1}}
\newcommand{\VerbatimStringTok}[1]{\textcolor[rgb]{0.31,0.60,0.02}{#1}}
\newcommand{\WarningTok}[1]{\textcolor[rgb]{0.56,0.35,0.01}{\textbf{\textit{#1}}}}
\usepackage{graphicx}
\makeatletter
\def\maxwidth{\ifdim\Gin@nat@width>\linewidth\linewidth\else\Gin@nat@width\fi}
\def\maxheight{\ifdim\Gin@nat@height>\textheight\textheight\else\Gin@nat@height\fi}
\makeatother
% Scale images if necessary, so that they will not overflow the page
% margins by default, and it is still possible to overwrite the defaults
% using explicit options in \includegraphics[width, height, ...]{}
\setkeys{Gin}{width=\maxwidth,height=\maxheight,keepaspectratio}
% Set default figure placement to htbp
\makeatletter
\def\fps@figure{htbp}
\makeatother
\setlength{\emergencystretch}{3em} % prevent overfull lines
\providecommand{\tightlist}{%
  \setlength{\itemsep}{0pt}\setlength{\parskip}{0pt}}
\setcounter{secnumdepth}{-\maxdimen} % remove section numbering
\definecolor{oldlace}{rgb}{1.00, 0.976,0.93}
\usepackage{booktabs}
\usepackage{longtable}
\usepackage{array}
\usepackage{multirow}
\usepackage{wrapfig}
\usepackage{float}
\usepackage{colortbl}
\usepackage{pdflscape}
\usepackage{tabu}
\usepackage{threeparttable}
\usepackage{threeparttablex}
\usepackage[normalem]{ulem}
\usepackage{makecell}
\usepackage{xcolor}
\ifluatex
  \usepackage{selnolig}  % disable illegal ligatures
\fi

\author{}
\date{\vspace{-2.5em}}

\begin{document}

\begin{titlepage}
\begin{center}
\includegraphics[width=0.4\textwidth]{/home/jgodet/Seafile/MaBibliotheque/hus/logo1.png}~ \\ [0.5cm]

\textsc{\normalsize H\^opitaux Universitaires de Strasbourg}\\ [2.5cm]

\textsc{\LARGE R\'esultats d'analyses statistiques}\\ [0.5cm]
\textsc{\LARGE pour}\\ [0.5cm]
\textsc{\LARGE  ~}\\ 
\vfill
\vfill
\vfill
\vfill
\vfill
\vfill
\vfill
\vfill
\vfill
\begin{minipage}{0.75\textwidth}
\begin{flushright}

\emph{Julien GODET}\\ 
\emph{MCU-PH}\\ 

\emph{P\^ole de Sant\'e Publique}\\ 
\emph{\href{mailto:julien.godet@chru-strasbourg.fr}{julien.godet@chru-strasbourg.fr}}\\\ 
\emph{\href{mailto:jgodet@unistra.fr}{julien.godet@unistra.fr}} 
~\\ 
\emph{\today}\\ 
\end{flushright}
\end{minipage}
\vfill
\vfill
\end{center}
\end{titlepage}
\newpage
\tableofcontents
\newpage

\hypertarget{objective}{%
\subsection{Objective}\label{objective}}

\textbf{Compare different methods to estimate ATE}

\begin{itemize}
\tightlist
\item
  synthetic data with binary treatment, binary outcome and
  binomial/uniform/normal covariates
\item
  known \(\psi\) (true-Psi) \(E(Y^1 - Y^0)\)
\item
  sampling from the population to create observational data (removing
  counterfactuals)
\item
  different sampling sizes from the fixed population (n = 5,000; 1,000;
  500; 200; 100 and 50)
\item
  estimations using TMLE, IPTW, misspecified IPTW model, g-formula for
  the different samples
\end{itemize}

\(\Box\) TODO : add IPTW with stabilized weights !!

\hypertarget{results}{%
\subsection{Results}\label{results}}

\begin{table}[H]
\centering
\resizebox{\linewidth}{!}{
\begin{tabular}{llllll}
\toprule
\textbf{Sample Size (n)} & \textbf{true-Psi} & \textbf{TMLE} & \textbf{IPTW} & \textbf{IPTW (unm. confounding)} & \textbf{g-formula}\\
\midrule
\cellcolor{oldlace}{5000} & \cellcolor{oldlace}{0.2203} & \cellcolor{oldlace}{0.216 [0.187 - 0.244]} & \cellcolor{oldlace}{0.223 [0.194 - 0.253]} & \cellcolor{oldlace}{0.257 [0.195 - 0.252]} & \cellcolor{oldlace}{0.218 [0.190 - 0.244]}\\
1000 & 0.2203 & 0.224 [0.158 - 0.290] & 0.236 [0.170 - 0.302] & 0.271 [0.174 - 0.299] & 0.236 [0.168 - 0.293]\\
\cellcolor{oldlace}{500} & \cellcolor{oldlace}{0.2203} & \cellcolor{oldlace}{0.196 [0.110 - 0.281]} & \cellcolor{oldlace}{0.218 [0.119 - 0.316]} & \cellcolor{oldlace}{0.255 [0.123 - 0.312]} & \cellcolor{oldlace}{0.198 [0.104 - 0.290]}\\
200 & 0.2203 & 0.191 [0.041 - 0.340] & 0.217 [0.066 - 0.368] & 0.259 [0.073 - 0.361] & 0.188 [0.038 - 0.311]\\
\cellcolor{oldlace}{100} & \cellcolor{oldlace}{0.2203} & \cellcolor{oldlace}{0.244 [0.071 - 0.418]} & \cellcolor{oldlace}{0.222 [0.011 - 0.433]} & \cellcolor{oldlace}{0.253 [0.018 - 0.427]} & \cellcolor{oldlace}{0.224 [0.040 - 0.382]}\\
\addlinespace
50 & 0.2203 & 0.241 [-0.011 - 0.494] & 0.177 [-0.145 - 0.499] & 0.278 [-0.125 - 0.479] & 0.140 [-0.165 - 0.403]\\
\bottomrule
\multicolumn{6}{l}{\textsuperscript{} unm. confounding : unmeasured confounding / misspecified PS model}\\
\end{tabular}}
\end{table}

\hypertarget{code}{%
\subsection{Code}\label{code}}

\scriptsize

\begin{Shaded}
\begin{Highlighting}[]
\CommentTok{\# JuG {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\# Wed Aug 11 17:58:01 2021 {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\FunctionTok{library}\NormalTok{(tidyverse)}
\FunctionTok{library}\NormalTok{(SuperLearner)}
\FunctionTok{set.seed}\NormalTok{(}\DecValTok{7}\NormalTok{)}

\CommentTok{\# using data generating code from Miguel Angel Luque Fernandez\textquotesingle{} tutorial}
\CommentTok{\#modified from Kat Hoffman @ https://github.com/hoffmakl/causal{-}club}
\NormalTok{generate\_data }\OtherTok{\textless{}{-}} \ControlFlowTok{function}\NormalTok{(n)\{}
\NormalTok{  w1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(n, }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{prob=}\FloatTok{0.5}\NormalTok{)}
\NormalTok{  w2 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(n, }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{prob=}\FloatTok{0.65}\NormalTok{)}
\NormalTok{  w3 }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{runif}\NormalTok{(n, }\AttributeTok{min=}\DecValTok{0}\NormalTok{, }\AttributeTok{max=}\DecValTok{4}\NormalTok{), }\AttributeTok{digits=}\DecValTok{3}\NormalTok{)}
\NormalTok{  w4 }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{runif}\NormalTok{(n, }\AttributeTok{min=}\DecValTok{0}\NormalTok{, }\AttributeTok{max=}\DecValTok{5}\NormalTok{), }\AttributeTok{digits=}\DecValTok{3}\NormalTok{)}
\NormalTok{  w5 }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{runif}\NormalTok{(n, }\AttributeTok{min=}\DecValTok{0}\NormalTok{, }\AttributeTok{max=}\DecValTok{5}\NormalTok{), }\AttributeTok{digits=}\DecValTok{3}\NormalTok{)}
\NormalTok{  w6 }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n, }\AttributeTok{mean =} \DecValTok{2}\NormalTok{, }\AttributeTok{sd =}\NormalTok{ .}\DecValTok{5}\NormalTok{), }\AttributeTok{digits=}\DecValTok{3}\NormalTok{)}
\NormalTok{  w7 }\OtherTok{\textless{}{-}} \FunctionTok{round}\NormalTok{(}\FunctionTok{rnorm}\NormalTok{(n, }\AttributeTok{mean =} \DecValTok{0}\NormalTok{, }\AttributeTok{sd=}\NormalTok{.}\DecValTok{3}\NormalTok{), }\AttributeTok{digits=}\DecValTok{3}\NormalTok{)}
\NormalTok{  w8 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(n, }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{prob=}\FloatTok{0.1}\NormalTok{)}
  
\NormalTok{  A  }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(n, }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{prob=} \FunctionTok{plogis}\NormalTok{(}\SpecialCharTok{{-}}\DecValTok{2}\SpecialCharTok{+} \FloatTok{0.2}\SpecialCharTok{*}\NormalTok{w2 }\SpecialCharTok{+} \FloatTok{0.15}\SpecialCharTok{*}\NormalTok{w3 }\SpecialCharTok{+} \FloatTok{0.2}\SpecialCharTok{*}\NormalTok{w4 }\SpecialCharTok{+} \FloatTok{0.15}\SpecialCharTok{*}\NormalTok{w2}\SpecialCharTok{*}\NormalTok{w4 }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ w8))}
  \CommentTok{\# counterfactual}
\NormalTok{  Y\_1 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(n, }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{prob=} \FunctionTok{plogis}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.5} \SpecialCharTok{+} \DecValTok{1} \SpecialCharTok{{-}}\FloatTok{0.1}\SpecialCharTok{*}\NormalTok{w1 }\SpecialCharTok{+} \FloatTok{0.3}\SpecialCharTok{*}\NormalTok{w2 }\SpecialCharTok{+} \FloatTok{0.25}\SpecialCharTok{*}\NormalTok{w3 }\SpecialCharTok{+} \FloatTok{0.2}\SpecialCharTok{*}\NormalTok{w4 }\SpecialCharTok{+} \FloatTok{0.15}\SpecialCharTok{*}\NormalTok{w2}\SpecialCharTok{*}\NormalTok{w4 }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ w8))}
\NormalTok{  Y\_0 }\OtherTok{\textless{}{-}} \FunctionTok{rbinom}\NormalTok{(n, }\AttributeTok{size=}\DecValTok{1}\NormalTok{, }\AttributeTok{prob=} \FunctionTok{plogis}\NormalTok{(}\SpecialCharTok{{-}}\FloatTok{1.5} \SpecialCharTok{+} \DecValTok{0} \SpecialCharTok{{-}}\FloatTok{0.1}\SpecialCharTok{*}\NormalTok{w1 }\SpecialCharTok{+} \FloatTok{0.3}\SpecialCharTok{*}\NormalTok{w2 }\SpecialCharTok{+} \FloatTok{0.25}\SpecialCharTok{*}\NormalTok{w3 }\SpecialCharTok{+} \FloatTok{0.2}\SpecialCharTok{*}\NormalTok{w4 }\SpecialCharTok{+} \FloatTok{0.15}\SpecialCharTok{*}\NormalTok{w2}\SpecialCharTok{*}\NormalTok{w4 }\SpecialCharTok{+}\NormalTok{ .}\DecValTok{3} \SpecialCharTok{*}\NormalTok{ w8))}
  \CommentTok{\# Observed outcome}
\NormalTok{  Y }\OtherTok{\textless{}{-}}\NormalTok{ Y\_1}\SpecialCharTok{*}\NormalTok{A }\SpecialCharTok{+}\NormalTok{ Y\_0}\SpecialCharTok{*}\NormalTok{(}\DecValTok{1} \SpecialCharTok{{-}}\NormalTok{ A)}
  \CommentTok{\# return data.frame}
  \FunctionTok{tibble}\NormalTok{(w1, w2, w3, w4, w5, w6, w7, w8, A, Y, Y\_1, Y\_0)}
\NormalTok{\}}

\CommentTok{\# observations N}
\NormalTok{n }\OtherTok{\textless{}{-}} \DecValTok{100000}

\CommentTok{\# full data set, including Y0 and Y0}
\NormalTok{dat\_full }\OtherTok{\textless{}{-}} \FunctionTok{generate\_data}\NormalTok{(n)}

\CommentTok{\# calculate the true psi if we saw both outcomes}
\NormalTok{true\_psi }\OtherTok{\textless{}{-}} \FunctionTok{mean}\NormalTok{(dat\_full}\SpecialCharTok{$}\NormalTok{Y\_1 }\SpecialCharTok{{-}}\NormalTok{ dat\_full}\SpecialCharTok{$}\NormalTok{Y\_0)}
\NormalTok{true\_psi}
\CommentTok{\#NOTE: keep this upper part as it is {-} change nsamp size below!}

\CommentTok{\# make a data set with observed data only}
\NormalTok{nsamp }\OtherTok{\textless{}{-}} \DecValTok{50}
\NormalTok{dat\_obs }\OtherTok{\textless{}{-}}\NormalTok{ dat\_full }\SpecialCharTok{\%\textgreater{}\%}
\NormalTok{  dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Y\_1,}\SpecialCharTok{{-}}\NormalTok{Y\_0) }\SpecialCharTok{\%\textgreater{}\%} 
  \FunctionTok{sample\_n}\NormalTok{(nsamp)}

\FunctionTok{table}\NormalTok{(dat\_obs}\SpecialCharTok{$}\NormalTok{A)}
\FunctionTok{table}\NormalTok{(dat\_obs}\SpecialCharTok{$}\NormalTok{Y)}
\CommentTok{\# set SL libraries}
\NormalTok{lib }\OtherTok{\textless{}{-}} \FunctionTok{c}\NormalTok{(}\StringTok{\textquotesingle{}SL.speedglm\textquotesingle{}}\NormalTok{, }\CommentTok{\# faster glm}
         \StringTok{\textquotesingle{}SL.glmnet\textquotesingle{}}\NormalTok{, }\CommentTok{\# lasso}
         \StringTok{\textquotesingle{}SL.ranger\textquotesingle{}}\NormalTok{, }\CommentTok{\# random forest}
         \StringTok{\textquotesingle{}SL.earth\textquotesingle{}}\NormalTok{)  }\CommentTok{\#}

\NormalTok{Y }\OtherTok{\textless{}{-}}\NormalTok{ dat\_obs}\SpecialCharTok{$}\NormalTok{Y}
\NormalTok{A }\OtherTok{\textless{}{-}}\NormalTok{ dat\_obs}\SpecialCharTok{$}\NormalTok{A}
\NormalTok{X\_A }\OtherTok{\textless{}{-}}\NormalTok{ dat\_obs }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Y, }\SpecialCharTok{{-}}\NormalTok{A)}

\CommentTok{\# Compare with TMLE package {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\NormalTok{tmle\_fit }\OtherTok{\textless{}{-}}\NormalTok{ tmle}\SpecialCharTok{::}\FunctionTok{tmle}\NormalTok{(Y, A, X\_A,}
                       \AttributeTok{gbound =}\NormalTok{ .}\DecValTok{0001}\NormalTok{, }\CommentTok{\# trying }
                       \AttributeTok{Q.SL.library =}\NormalTok{ lib, }\AttributeTok{g.SL.library =}\NormalTok{ lib)}
\NormalTok{tmle\_fit}\SpecialCharTok{$}\NormalTok{epsilon }\CommentTok{\# mine are different :(}
\NormalTok{tmle\_fit}\SpecialCharTok{$}\NormalTok{estimates}\SpecialCharTok{$}\NormalTok{ATE}


\CommentTok{\# g{-}formula{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}


\FunctionTok{library}\NormalTok{(RISCA)}
\CommentTok{\#Marginal effects of the treatment (ATE)}
\NormalTok{dat\_obs2 }\OtherTok{\textless{}{-}} \FunctionTok{as.data.frame}\NormalTok{(dat\_obs) }\CommentTok{\#NOTE does not work with tibble!}

\NormalTok{glm.multi }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(Y }\SpecialCharTok{\textasciitilde{}}\NormalTok{ ., }\AttributeTok{data=}\NormalTok{dat\_obs2, }\AttributeTok{family =}\NormalTok{ binomial)}

\NormalTok{gc.ate }\OtherTok{\textless{}{-}} \FunctionTok{gc.logistic}\NormalTok{(}\AttributeTok{glm.obj=}\NormalTok{glm.multi, }\AttributeTok{data=}\NormalTok{dat\_obs2, }\AttributeTok{group=}\StringTok{"A"}\NormalTok{, }\AttributeTok{effect=}\StringTok{"ATE"}\NormalTok{,}
                      \AttributeTok{var.method=}\StringTok{"simulations"}\NormalTok{, }\AttributeTok{iterations=}\DecValTok{1000}\NormalTok{)}

\CommentTok{\#{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}
\CommentTok{\#{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# IPTW}
\FunctionTok{library}\NormalTok{(survey)}
\FunctionTok{library}\NormalTok{(tableone)}
\FunctionTok{library}\NormalTok{(sandwich) }\CommentTok{\#for robust variance estimation}

\NormalTok{psModel }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A}\SpecialCharTok{\textasciitilde{}}\NormalTok{., }\AttributeTok{data=}\NormalTok{ dat\_obs }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Y), }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{)}
\CommentTok{\# require(MASS)}
\CommentTok{\# stepAIC(psModel)}
\CommentTok{\# psModel \textless{}{-} glm(formula = A \textasciitilde{}  w1+w2+w4+w8, family = "binomial", }
\CommentTok{\#                data = dat\_obs)}
\CommentTok{\#psModel \textless{}{-} glm(A\textasciitilde{}w1 + w2 + w3 + w4, data= dat\_obs, family = "binomial")}

\DocumentationTok{\#\# value of propensity score for each subject}
\NormalTok{ps }\OtherTok{\textless{}{-}}\FunctionTok{predict}\NormalTok{(psModel, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\CommentTok{\#create weights}
\NormalTok{weight}\OtherTok{\textless{}{-}}\FunctionTok{ifelse}\NormalTok{(dat\_obs}\SpecialCharTok{$}\NormalTok{A}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\DecValTok{1}\SpecialCharTok{/}\NormalTok{(ps),}\DecValTok{1}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{ps))}

\CommentTok{\#apply weights to data}
\NormalTok{weighteddata}\OtherTok{\textless{}{-}}\FunctionTok{svydesign}\NormalTok{(}\AttributeTok{ids =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{dat\_obs, }\AttributeTok{weights =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ weight)}

\CommentTok{\#weighted table 1}
\NormalTok{weightedtable }\OtherTok{\textless{}{-}}\FunctionTok{svyCreateTableOne}\NormalTok{(}\AttributeTok{vars =} \FunctionTok{paste}\NormalTok{(}\StringTok{"w"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{sep=}\StringTok{""}\NormalTok{), }\AttributeTok{strata =} \StringTok{"A"}\NormalTok{, }
                                  \AttributeTok{data =}\NormalTok{ weighteddata, }\AttributeTok{test =} \ConstantTok{FALSE}\NormalTok{)}
\DocumentationTok{\#\# Show table with SMD}
\FunctionTok{print}\NormalTok{(weightedtable, }\AttributeTok{smd =} \ConstantTok{TRUE}\NormalTok{)}

\CommentTok{\#get causal risk difference}
\NormalTok{glm.obj}\OtherTok{\textless{}{-}}\FunctionTok{glm}\NormalTok{(Y}\SpecialCharTok{\textasciitilde{}}\NormalTok{A,}\AttributeTok{weights=}\NormalTok{weight,}\AttributeTok{family=}\FunctionTok{binomial}\NormalTok{(}\AttributeTok{link=}\StringTok{"log"}\NormalTok{), }\AttributeTok{data=}\NormalTok{dat\_obs)}




\FunctionTok{summary}\NormalTok{(weight)}
\CommentTok{\#truncate weights at 5}

\NormalTok{truncweight}\OtherTok{\textless{}{-}}\FunctionTok{replace}\NormalTok{(weight,weight}\SpecialCharTok{\textgreater{}}\DecValTok{5}\NormalTok{,}\DecValTok{5}\NormalTok{)}
\CommentTok{\#get causal risk difference}
\NormalTok{glm.obj}\OtherTok{\textless{}{-}}\FunctionTok{glm}\NormalTok{(Y}\SpecialCharTok{\textasciitilde{}}\NormalTok{A,}\AttributeTok{weights=}\NormalTok{truncweight,}\AttributeTok{family=}\FunctionTok{quasibinomial}\NormalTok{(}\AttributeTok{link=}\StringTok{"identity"}\NormalTok{), }\AttributeTok{data=}\NormalTok{dat\_obs)}
\CommentTok{\#summary(glm.obj)}
\NormalTok{betaiptw}\OtherTok{\textless{}{-}}\FunctionTok{coef}\NormalTok{(glm.obj)}

\NormalTok{SE}\OtherTok{\textless{}{-}}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{vcovHC}\NormalTok{(glm.obj, }\AttributeTok{type=}\StringTok{"HC0"}\NormalTok{)))}

\NormalTok{causalrd}\OtherTok{\textless{}{-}}\NormalTok{(betaiptw[}\DecValTok{2}\NormalTok{])}
\NormalTok{lcl}\OtherTok{\textless{}{-}}\NormalTok{(betaiptw[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\FloatTok{1.96}\SpecialCharTok{*}\NormalTok{SE[}\DecValTok{2}\NormalTok{])}
\NormalTok{ucl}\OtherTok{\textless{}{-}}\NormalTok{(betaiptw[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\FloatTok{1.96}\SpecialCharTok{*}\NormalTok{SE[}\DecValTok{2}\NormalTok{])}
\FunctionTok{c}\NormalTok{(lcl,causalrd,ucl)}



\CommentTok{\# misspecified model {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\NormalTok{mpsModel }\OtherTok{\textless{}{-}} \FunctionTok{glm}\NormalTok{(A}\SpecialCharTok{\textasciitilde{}}\NormalTok{w1}\SpecialCharTok{+}\NormalTok{w2}\SpecialCharTok{+}\NormalTok{w3}\SpecialCharTok{+}\NormalTok{w7, }\AttributeTok{data=}\NormalTok{ dat\_obs }\SpecialCharTok{\%\textgreater{}\%}\NormalTok{ dplyr}\SpecialCharTok{::}\FunctionTok{select}\NormalTok{(}\SpecialCharTok{{-}}\NormalTok{Y), }\AttributeTok{family =} \StringTok{"binomial"}\NormalTok{)}
\CommentTok{\# require(MASS)}
\CommentTok{\# stepAIC(psModel)}
\CommentTok{\# psModel \textless{}{-} glm(formula = A \textasciitilde{}  w1+w2+w4+w8, family = "binomial", }
\CommentTok{\#                data = dat\_obs)}
\CommentTok{\#psModel \textless{}{-} glm(A\textasciitilde{}w1 + w2 + w3 + w4, data= dat\_obs, family = "binomial")}

\DocumentationTok{\#\# value of propensity score for each subject}
\NormalTok{mps }\OtherTok{\textless{}{-}}\FunctionTok{predict}\NormalTok{(mpsModel, }\AttributeTok{type =} \StringTok{"response"}\NormalTok{)}

\CommentTok{\#create weights}
\NormalTok{mweight}\OtherTok{\textless{}{-}}\FunctionTok{ifelse}\NormalTok{(dat\_obs}\SpecialCharTok{$}\NormalTok{A}\SpecialCharTok{==}\DecValTok{1}\NormalTok{,}\DecValTok{1}\SpecialCharTok{/}\NormalTok{(mps),}\DecValTok{1}\SpecialCharTok{/}\NormalTok{(}\DecValTok{1}\SpecialCharTok{{-}}\NormalTok{mps))}

\CommentTok{\#apply weights to data}
\NormalTok{mweighteddata}\OtherTok{\textless{}{-}}\FunctionTok{svydesign}\NormalTok{(}\AttributeTok{ids =} \SpecialCharTok{\textasciitilde{}} \DecValTok{1}\NormalTok{, }\AttributeTok{data =}\NormalTok{dat\_obs, }\AttributeTok{weights =} \SpecialCharTok{\textasciitilde{}}\NormalTok{ mweight)}

\CommentTok{\#weighted table 1}
\NormalTok{mweightedtable }\OtherTok{\textless{}{-}}\FunctionTok{svyCreateTableOne}\NormalTok{(}\AttributeTok{vars =} \FunctionTok{paste}\NormalTok{(}\StringTok{"w"}\NormalTok{, }\DecValTok{1}\SpecialCharTok{:}\DecValTok{8}\NormalTok{, }\AttributeTok{sep=}\StringTok{""}\NormalTok{), }\AttributeTok{strata =} \StringTok{"A"}\NormalTok{, }
                                  \AttributeTok{data =}\NormalTok{ mweighteddata, }\AttributeTok{test =} \ConstantTok{FALSE}\NormalTok{)}
\DocumentationTok{\#\# Show table with SMD}
\FunctionTok{print}\NormalTok{(mweightedtable, }\AttributeTok{smd =} \ConstantTok{TRUE}\NormalTok{)}

\CommentTok{\#get causal risk difference}
\NormalTok{glm.obj}\OtherTok{\textless{}{-}}\FunctionTok{glm}\NormalTok{(Y}\SpecialCharTok{\textasciitilde{}}\NormalTok{A,}\AttributeTok{weights=}\NormalTok{mweight,}\AttributeTok{family=}\FunctionTok{binomial}\NormalTok{(}\AttributeTok{link=}\StringTok{"log"}\NormalTok{), }\AttributeTok{data=}\NormalTok{dat\_obs)}
\FunctionTok{summary}\NormalTok{(mweight)}

\CommentTok{\#truncate weights at 5}
\NormalTok{mtruncweight}\OtherTok{\textless{}{-}}\FunctionTok{replace}\NormalTok{(mweight,mweight}\SpecialCharTok{\textgreater{}}\DecValTok{5}\NormalTok{,}\DecValTok{5}\NormalTok{)}
\CommentTok{\#get causal risk difference}
\NormalTok{mglm.obj}\OtherTok{\textless{}{-}}\FunctionTok{glm}\NormalTok{(Y}\SpecialCharTok{\textasciitilde{}}\NormalTok{A,}\AttributeTok{weights=}\NormalTok{mtruncweight,}\AttributeTok{family=}\FunctionTok{quasibinomial}\NormalTok{(}\AttributeTok{link=}\StringTok{"identity"}\NormalTok{), }\AttributeTok{data=}\NormalTok{dat\_obs)}
\CommentTok{\#summary(glm.obj)}
\NormalTok{mbetaiptw}\OtherTok{\textless{}{-}}\FunctionTok{coef}\NormalTok{(mglm.obj)}

\NormalTok{SE}\OtherTok{\textless{}{-}}\FunctionTok{sqrt}\NormalTok{(}\FunctionTok{diag}\NormalTok{(}\FunctionTok{vcovHC}\NormalTok{(mglm.obj, }\AttributeTok{type=}\StringTok{"HC0"}\NormalTok{)))}

\NormalTok{mcausalrd}\OtherTok{\textless{}{-}}\NormalTok{(mbetaiptw[}\DecValTok{2}\NormalTok{])}
\NormalTok{mlcl}\OtherTok{\textless{}{-}}\NormalTok{(betaiptw[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{{-}}\FloatTok{1.96}\SpecialCharTok{*}\NormalTok{SE[}\DecValTok{2}\NormalTok{])}
\NormalTok{mucl}\OtherTok{\textless{}{-}}\NormalTok{(betaiptw[}\DecValTok{2}\NormalTok{]}\SpecialCharTok{+}\FloatTok{1.96}\SpecialCharTok{*}\NormalTok{SE[}\DecValTok{2}\NormalTok{])}
\FunctionTok{c}\NormalTok{(mlcl,mcausalrd,mucl)}

\CommentTok{\# output {-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}{-}}

\CommentTok{\# dput(c(paste(nsamp), }
\CommentTok{\#        paste(format(round(true\_psi,4), nsmall=4)),}
\CommentTok{\# paste(format(round(tmle\_fit$estimates$ATE$psi, 3), nsmall=3), " [", }
\CommentTok{\#       format(round(tmle\_fit$estimates$ATE$CI[1], 3),nsmall=3), " {-} ", }
\CommentTok{\#       format(round(tmle\_fit$estimates$ATE$CI[2], 3),nsmall=3), "]", sep=""),}
\CommentTok{\# paste(format(round(causalrd, 3), nsmall=3), " [", format(round(lcl, 3),nsmall=3), " {-} ", }
\CommentTok{\#       format(round(ucl, 3),nsmall=3), "]", sep=""),}
\CommentTok{\# paste(format(round(mcausalrd, 3), nsmall=3), " [", format(round(mlcl, 3),nsmall=3), " {-} ", }
\CommentTok{\#       format(round(mucl, 3),nsmall=3), "]", sep=""),}
\CommentTok{\# paste(format(round(gc.ate$delta[[1]], 3), nsmall=3), " [", }
\CommentTok{\#       format(round(gc.ate$delta[[3]], 3),nsmall=3), " {-} ", }
\CommentTok{\#       format(round(gc.ate$delta[[4]], 3),nsmall=3), "]", }
\CommentTok{\#       sep="")))}
\end{Highlighting}
\end{Shaded}


\end{document}
